<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dealer Image Upload Demo - AutoSherpa</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section { 
            margin: 30px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px;
        }
        .section h2 { 
            color: #333; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 10px;
        }
        .form-group { 
            margin: 15px 0; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: #555;
        }
        input, select { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px;
        }
        button:hover { 
            background: #0056b3; 
        }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-info { background: #17a2b8; }
        .btn-info:hover { background: #117a8b; }
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 5px; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .image-preview { 
            margin: 10px 0; 
            text-align: center; 
        }
        .image-preview img { 
            max-width: 200px; 
            max-height: 150px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .whatsapp-demo { 
            background: #25D366; 
            color: white; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 20px 0;
        }
        .flow-diagram { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0;
            text-align: center;
        }
        .flow-step { 
            display: inline-block; 
            margin: 10px; 
            padding: 15px; 
            background: white; 
            border: 2px solid #007bff; 
            border-radius: 8px; 
            min-width: 120px;
        }
        .arrow { 
            font-size: 24px; 
            color: #007bff; 
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó AutoSherpa Dealer Image System Demo</h1>
        <p>This demonstrates how dealers upload car images and how the WhatsApp bot accesses them.</p>
        
        <div class="flow-diagram">
            <div class="flow-step">üì∏ Dealer Uploads</div>
            <div class="arrow">‚Üí</div>
            <div class="flow-step">‚òÅÔ∏è Cloud Storage</div>
            <div class="arrow">‚Üí</div>
            <div class="flow-step">üì± WhatsApp Bot</div>
        </div>

        <div class="section">
            <h2>üì∏ Step 1: Dealer Uploads Car Images</h2>
            <p>Dealers can upload multiple images for each car with specific types (front, back, side, interior).</p>
            
            <form id="uploadForm">
                <div class="form-group">
                    <label for="registrationNumber">Car Registration Number:</label>
                    <input type="text" id="registrationNumber" name="registrationNumber" 
                           value="DEMO001" required placeholder="e.g., DEMO001">
                </div>
                
                <div class="form-group">
                    <label for="imageFiles">Select Image Files:</label>
                    <input type="file" id="imageFiles" name="images" accept="image/*" multiple required>
                    <small>You can select multiple images at once</small>
                </div>
                
                <div class="form-group">
                    <label for="imageTypes">Image Types (comma-separated):</label>
                    <input type="text" id="imageTypes" name="imageTypes" 
                           value="front,back,side,interior" placeholder="e.g., front,back,side,interior">
                    <small>Types will be assigned in order: front=1, back=2, side=3, interior=4</small>
                </div>
                
                <button type="submit" class="btn-success">üì§ Upload Images</button>
            </form>
            
            <div id="uploadResult"></div>
        </div>

        <div class="section">
            <h2>üîç Step 2: Test WhatsApp Bot Image Access</h2>
            <p>Test how the WhatsApp bot would fetch images for a specific car registration number.</p>
            
            <div class="form-group">
                <label for="testRegistration">Registration Number to Test:</label>
                <input type="text" id="testRegistration" value="DEMO001" placeholder="Enter registration number">
                <button onclick="testWhatsAppBot()" class="btn-info">üì± Test WhatsApp Bot Access</button>
            </div>
            
            <div id="whatsappResult"></div>
        </div>

        <div class="section">
            <h2>üìä Current Database Status</h2>
            <div id="dbStatus">Loading...</div>
        </div>

        <div class="whatsapp-demo">
            <h3>üí¨ WhatsApp Bot Integration</h3>
            <p><strong>API Endpoint:</strong> <code>/api/whatsapp/car-images/{registrationNumber}</code></p>
            <p><strong>No Authentication Required:</strong> WhatsApp bot can access images directly</p>
            <p><strong>Response Format:</strong> JSON with car details and image URLs</p>
        </div>
    </div>

    <script>
        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                document.getElementById('uploadResult').innerHTML = 
                    '<div class="error">‚ùå Please log in first to test uploads</div>';
                return false;
            }
            return true;
        }
        
        // Handle form submission
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!checkAuth()) return;
            
            const formData = new FormData();
            const fileInput = document.getElementById('imageFiles');
            const registrationNumber = document.getElementById('registrationNumber').value;
            const imageTypes = document.getElementById('imageTypes').value.split(',').map(t => t.trim());
            
            if (!fileInput.files.length) {
                document.getElementById('uploadResult').innerHTML = 
                    '<div class="error">‚ùå Please select image files</div>';
                return;
            }
            
            // Add files and metadata
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('images', fileInput.files[i]);
            }
            formData.append('registrationNumber', registrationNumber);
            formData.append('imageTypes', JSON.stringify(imageTypes));
            formData.append('imageIndices', JSON.stringify([...Array(fileInput.files.length).keys()]));
            
            const resultDiv = document.getElementById('uploadResult');
            resultDiv.innerHTML = '<div class="info">‚è≥ Uploading images...</div>';
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/upload-car-images', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    let html = `
                        <div class="success">
                            ‚úÖ Upload successful!<br>
                            <strong>Car ID:</strong> ${result.carId}<br>
                            <strong>Registration:</strong> ${result.registrationNumber}<br>
                            <strong>Images uploaded:</strong> ${result.images.length}
                        </div>
                    `;
                    
                    // Show image details
                    html += '<h4>üì∏ Uploaded Images:</h4>';
                    result.images.forEach((img, index) => {
                        const type = imageTypes[index] || 'unknown';
                        html += `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <strong>${type}:</strong> ${img.filename}<br>
                                <strong>Path:</strong> ${img.path}<br>
                                <strong>Sequence:</strong> ${img.sequence}
                            </div>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                    
                    // Refresh database status
                    loadDatabaseStatus();
                    
                } else {
                    const errorData = await response.json();
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Upload failed: ${errorData.error || 'Unknown error'}
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Upload error: ${error.message}
                    </div>
                `;
            }
        });
        
        // Test WhatsApp bot access
        async function testWhatsAppBot() {
            const registrationNumber = document.getElementById('testRegistration').value;
            const resultDiv = document.getElementById('whatsappResult');
            
            if (!registrationNumber) {
                resultDiv.innerHTML = '<div class="error">‚ùå Please enter a registration number</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="info">‚è≥ Testing WhatsApp bot access...</div>';
            
            try {
                const response = await fetch(`/api/whatsapp/car-images/${registrationNumber}`);
                
                if (response.ok) {
                    const result = await response.json();
                    let html = `
                        <div class="success">
                            ‚úÖ WhatsApp bot can access car: ${result.car.registration_number}<br>
                            <strong>Brand:</strong> ${result.car.brand} ${result.car.model}<br>
                            <strong>Year:</strong> ${result.car.year}<br>
                            <strong>Price:</strong> ‚Çπ${result.car.price}<br>
                            <strong>Images available:</strong> ${result.images.length}
                        </div>
                    `;
                    
                    if (result.images.length > 0) {
                        html += '<h4>üì∏ Images for WhatsApp Bot:</h4>';
                        result.images.forEach((img, index) => {
                            html += `
                                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <strong>${img.type}:</strong> Sequence ${img.sequence}<br>
                                    <strong>URL:</strong> <a href="${img.url}" target="_blank">${img.url}</a>
                                </div>
                            `;
                        });
                    }
                    
                    resultDiv.innerHTML = html;
                    
                } else {
                    const errorData = await response.json();
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå WhatsApp bot access failed: ${errorData.error || 'Unknown error'}<br>
                            <small>${errorData.message || ''}</small>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Test error: ${error.message}
                    </div>
                `;
            }
        }
        
        // Load database status
        async function loadDatabaseStatus() {
            const container = document.getElementById('dbStatus');
            
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    container.innerHTML = '<div class="error">‚ùå Not logged in</div>';
                    return;
                }
                
                const response = await fetch('/api/cars', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const cars = await response.json();
                    let carsWithImages = cars.filter(car => car.image_paths && car.image_paths.length > 0);
                    
                    let html = `<p><strong>Total cars:</strong> ${cars.length}</p>`;
                    html += `<p><strong>Cars with images:</strong> ${carsWithImages.length}</p>`;
                    
                    if (carsWithImages.length > 0) {
                        html += '<h4>Recent uploads:</h4>';
                        carsWithImages.forEach(car => {
                            html += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">`;
                            html += `<strong>${car.registration_number}</strong> (${car.brand} ${car.model})<br>`;
                            html += `Images: ${car.image_paths.length}<br>`;
                            car.image_paths.forEach((path, i) => {
                                const type = car.image_types[i] || 'unknown';
                                if (path.startsWith('http')) {
                                    html += `<span style="color: green;">‚òÅÔ∏è ${type}: Cloudinary URL</span><br>`;
                                } else {
                                    html += `<span style="color: blue;">üìÅ ${type}: Local path</span><br>`;
                                }
                            });
                            html += `</div>`;
                        });
                    }
                    
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="error">‚ùå Failed to load cars data</div>';
                }
                
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Load status when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadDatabaseStatus();
        });
    </script>
</body>
</html>
